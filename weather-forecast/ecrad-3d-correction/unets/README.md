# 3D Correction

## Description

Weather and climate models operate at limited resolution that cannot resolve physical processes like clouds, radiation or turbulence, for instance. Theses processes are important and are represented by parameterisation schemes that formulate the physical process using resolved atmospheric variables.

In the atmosphere, absorption, emission or scattering of short-wave (SW) and long-wave (LW) radiation are important processes. Short-wave radiation is the major source of energy of the Earth system. Long-wave radiation is emitted by the Earth surface and the atmosphere and is responsible for the greenhouse effect.

The solution of the radiative transfer equations to obtain the fluxes are computationnaly expensive and, in practice, calculations are performed on a coarser resolution and/or using an increased timestep (lower time frequency). The fluxes are later interpolated back to the original (finer) grid. The Integrated Forecasting System (IFS), the operational numerical weather prediction model developed by ECMWF, comes with the ecRad scheme (https://github.com/ecmwf-ifs/ecrad) that implements several solvers. Two of them represent the horizontal cloud inhomogeneity: Tripleclouds (Shonk and Hogan, 2008) and SPARTACUS ( Speedy Algorithm for Radiative Transfer through Cloud Sides -- Hogan et al., 2016). SPARTACUS can be seen an extension of Tripleclouds by treating the 3D radiative effects associated with clouds but is currently too expensive for operational weather predictions (approximatively five times slower).\
*N.B.: This number should be updated based on Ukkonen and Hogan (2024) but one should keep in mind that they reduced the precision of the two-stream kernel computations to achieve better performance.*

The present task aims at learning the 3D cloud radiative effects that will be integrated to Tripleclouds formulation as a corrective term. Learning a corrective term instead of the entire SPARTACUS solver focuses on the most computationally intensive aspects of this solver.
The neural network has to learn the difference between the outputs of SPARTACUS and Tripleclouds (SW/LW fluxes and heating rates).

## Dataset

The dataset has been generated by ECMWF as a delivrable of the [MAELSTROM project](https://www.maelstrom-eurohpc.eu/) project. It can be downloaded using the [Climetlab](https://github.com/ecmwf/climetlab) library also developed by ECMWF.

The dataset is widely explained in the MAESLTROM radiation repository (https://git.ecmwf.int/projects/MLFET/repos/maelstrom-radiation/browse). 

Before training the neural network, a preprocessing step is required that will transform the NetCDF dataset into a Zarr dataset.
The parameters for the normalization (means and standard deviations) are computed during this step. 

Original features:

* ``sca_inputs`` (*column x sca_variable*):
    - skin_temperature,
    - cos_solar_zenith_angle,
    - sw_albedo,
    - sw_albedo_direct,
    - lw_emissivity and
    - solar_irradiance
* ``col_inputs`` (*column x level x col_variable*):
    - q, o3_mmr,
    - co2_vmr,
    - n2o_vmr,
    - ch4_vmr,
    - o2_vmr,
    - cfc11_vmr,
    - cfc12_vmr,
    - hcfc22_vmr,
    - ccl4_vmr,
    - cloud_fraction,
    - aerosol_mmr (12 type),
    - q_liquid,
    - q_ice,
    - re_liquid and
    - re_ice
* ``hl_inputs`` (*column x half_level x hl_variable*):
    - temperature_hl and
    - pressure_hl
* ``inter_inputs`` (*column x level_interface x inter_variable*):
    - overlap_param
* ``hl_pressure`` (pressure_hl -- kept alone to be used to compute the heating rates).

**&rarr; concatenated into one tensor of shape *column x half_level x 47***

Original targets:

* ``flux_dn_sw`` (*column x half_level*): difference of downwelling short-wave fluxes
* ``flux_up_sw`` (*column x half_level*): difference of upwelling short-wave fluxes
* ``flux_dn_lw`` (*column x half_level*): difference of downwelling long-wave fluxes
* ``flux_up_lw`` (*column x half_level*): difference of upwelling long-wave fluxes
* ``hr_sw`` (*column x level*): difference of short-wave heating rates
* ``hr_lw`` (*column x level*): difference of long-wave heating rates

**&rarr; concatenated into one tensor of shape *column x half_level x 6***

## Models

The architecture of the neural network is a classical 1D U-Net (more to come).\
