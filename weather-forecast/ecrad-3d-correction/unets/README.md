# 3D Correction

## Description

Weather and climate models operate at limited resolution that cannot resolve physical processes like clouds, radiation or turbulence, for instance. Theses processes are important and are represented by parameterisation schemes that formulate the physical process using resolved atmospheric variables.

In the atmosphere, absorption, emission or scattering of short-wave (SW) and long-wave (LW) radiation are important processes. Short-wave radiation is the major source of energy of the Earth system. Long-wave radiation is emitted by the Earth surface and the atmosphere and is responsible for the greenhouse effect.

The solution of the radiative transfer equations to obtain the fluxes are computationnaly expensive and, in practice, calculations are performed on a coarser resolution and/or using an increased timestep (lower time frequency). The fluxes are later interpolated back to the original (finer) grid. The Integrated Forecasting System (IFS), the operational numerical weather prediction model developed by ECMWF, comes with the ecRad scheme (https://github.com/ecmwf-ifs/ecrad) that implements several solvers. Two of them represent the horizontal cloud inhomogeneity: Tripleclouds *(Shonk and Hogan, 2008)* and SPARTACUS ( Speedy Algorithm for Radiative Transfer through Cloud Sides; *Hogan et al., 2016*). SPARTACUS can be seen an extension of Tripleclouds by treating the 3D radiative effects associated with clouds but is currently too expensive for operational weather predictions (approximatively five times slower).\
*N.B.: This number should be updated based on Ukkonen and Hogan (2024) but one should keep in mind that they reduced the precision of the two-stream kernel computations to achieve better performance.*

The present task aims at learning the 3D cloud radiative effects that will be integrated to Tripleclouds formulation as a corrective term. Learning a corrective term instead of the entire SPARTACUS solver focuses on the most computationally intensive aspects of this solver.
The neural network has to learn the difference between the outputs of SPARTACUS and Tripleclouds (SW/LW fluxes and heating rates).

**This work builds on the research of *Meyer et al. (2021)* but uses higher-quality data and a more suitable neural network.**

## Dataset

The dataset has been generated by ECMWF as a delivrable of the [MAELSTROM project](https://www.maelstrom-eurohpc.eu/) project. It can be downloaded using the [Climetlab](https://github.com/ecmwf/climetlab) library also developed by ECMWF.

The dataset is widely explained in the MAESLTROM radiation repository (https://git.ecmwf.int/projects/MLFET/repos/maelstrom-radiation/browse). 

Before training the neural network, a preprocessing step is required that will transform the NetCDF dataset into a Zarr dataset.
The parameters for the normalization (means and standard deviations) are computed during this step. 

All the following atmospheric variables are presented in [ecRad User Guide](https://confluence.ecmwf.int/download/attachments/70945505/ecrad_documentation.pdf?version=5&modificationDate=1655480733414&api=v2) (Tables 2.1 and 2.2).

Original features:

* ``sca_inputs`` (*column x sca_variable*):
    - skin_temperature,
    - cos_solar_zenith_angle,
    - sw_albedo,
    - sw_albedo_direct,
    - lw_emissivity and
    - solar_irradiance
* ``col_inputs`` (*column x level x col_variable*):
    - q,
    - o3_mmr,
    - co2_vmr,
    - n2o_vmr,
    - ch4_vmr,
    - o2_vmr,
    - cfc11_vmr,
    - cfc12_vmr,
    - hcfc22_vmr,
    - ccl4_vmr,
    - cloud_fraction,
    - aerosol_mmr (12 type),
    - q_liquid,
    - q_ice,
    - re_liquid and
    - re_ice
* ``hl_inputs`` (*column x half_level x hl_variable*):
    - temperature_hl and
    - pressure_hl
* ``inter_inputs`` (*column x level_interface x inter_variable*):
    - overlap_param
* ``hl_pressure`` (pressure_hl -- kept alone to be used to compute the heating rates).

**&rarr; concatenated into one tensor of shape *column x half_level x 47***

Original targets:

* ``flux_dn_sw`` (*column x half_level*): difference of downwelling short-wave fluxes
* ``flux_up_sw`` (*column x half_level*): difference of upwelling short-wave fluxes
* ``flux_dn_lw`` (*column x half_level*): difference of downwelling long-wave fluxes
* ``flux_up_lw`` (*column x half_level*): difference of upwelling long-wave fluxes
* ``hr_sw`` (*column x level*): difference of short-wave heating rates
* ``hr_lw`` (*column x level*): difference of long-wave heating rates

**&rarr; concatenated into one tensor of shape *column x half_level x 6***

## Models

The architecture of the neural network is a classical 1D U-Net (more to come).

## References

Hogan, R. J., Schäfer, S. A. K., Klinger, C., Chiu, J. C., & Mayer, B. (2016). Representing 3‐D cloud
radiation effects in two‐stream schemes: 2. Matrix formulation and broadband evaluation. Journal of
Geophysical Research: Atmospheres, 121(14), 8583–8599. https://doi.org/10.1002/2016JD024875 

Meyer, D., Hogan, R. J., Dueben, P. D., & Mason, S. L. (2022). Machine learning emulation of 3D cloud radiative effects. Journal of Advances in Modeling Earth Systems, 14, e2021MS002550. https://doi.org/10.1029/2021MS002550

Shonk, J. K. P., & Hogan, R. J. (2008). Tripleclouds: An efficient method for representing horizontal cloud inhomogeneity in 1D radiation schemes by using three regions at each height. Journal of Climate, 21(11), 2352–2370. https://doi.org/10.1175/2007JCLI1940.1

Ukkonen, P., & Hogan, R. J. (2024). Twelve times faster yet accurate: A new state-of-the-art in radiation schemes via performance and spectral optimization. Journal of Advances in Modeling Earth Systems, 16, e2023MS003932. https://doi.org/10.1029/2023MS003932