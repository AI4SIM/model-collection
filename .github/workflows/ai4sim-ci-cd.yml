name: ai4sim-ci-cd

on: [push, pull_request]

jobs:
  run-checks:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: [3.8, 3.9]
        test-path: 
          - combustion/gnns/
#          - combustion/unets/
#          - weather_forecast/gwd/
    steps:
    - uses: actions/checkout@v2
    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v2
      with:
        python-version: ${{ matrix.python-version }}
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pylint
    - name: Extract the required torch version
      run: |
        echo "TORCH_VERS=$(sed -nE 's/^torch==()/\1/p' ${{ matrix.test-path }}/requirements.txt)" >> $GITHUB_ENV
    - name: Install requirements
      run: |
        if [ -f ${{ matrix.test-path }}/requirements.txt ]; then
          # for now, no cuda is installed on the build container so the cpu version of torch-linked libraries are used
          python -m pip install -r ${{ matrix.test-path }}/requirements.txt -f https://data.pyg.org/whl/torch-${TORCH_VERS}+cpu.html
        fi
    - name: Analysing the code with pylint
      run: |
        pylint '${{ matrix.test-path }}/tests/'
    - name: Install pytest
      run: |
        pip install pytest pytest-cov
    - name: Run unit tests
      run: |
        python -m pytest --import-mode=append ${{ matrix.test-path }}/tests/
    - name: Run coverage
      run: |
        python -m pytest --cache-clear --cov=${{ matrix.test-path }} ${{ matrix.test-path }}/tests/ > ${{ matrix.test-path }}/pytest-coverage.txt 
    - name: Coverage Commentator
      uses: coroo/pytest-coverage-commentator@v1.0.2
      with:
        pytest-coverage: ${{ matrix.test-path }}/pytest-coverage.txt
